name: SonarQube Analysis

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    sonarqube:
        runs-on: ubuntu-latest

        steps:
          - name: Checkout code
            uses: actions/checkout@v4

          - name: Set up JDK 17
            uses: actions/setup-java@v3
            with:
              java-version: '17'
              distribution: 'temurin'

          - name: Cache SonarQube packages
            uses: actions/cache@v3
            with:
              path: ~/.sonar/cache
              key: ${{ runner.os }}-sonar
              restore-keys: ${{ runner.os }}-sonar

          - name: SonarQube Scan
            env:
              SONAR_TOKEN: ${{ secrets.SONAR_TOKEN || '' }}
              SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL || '' }}
              SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY || '' }}
            run: |
              if [ -z "$SONAR_TOKEN" ] || [ -z "$SONAR_HOST_URL" ]; then
                echo "SONAR_TOKEN or SONAR_HOST_URL is not set. Skipping SonarQube scan."
                exit 1
              fi
              ./gradlew sonarqube \
                -Dsonar.projectKey=$SONAR_PROJECT_KEY \
                -Dsonar.host.url=$SONAR_HOST_URL \
                -Dsonar.login=$SONAR_TOKEN